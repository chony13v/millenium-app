rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ─────────────────────── Helpers ─────────────────────── */
    function isOwnerUidOrEmail(userId) {
      return request.auth != null &&
        (
          request.auth.uid == userId ||
          (request.auth.token.email != null && request.auth.token.email == userId)
        );
    }

    function isNullableString(field) {
      return field is string || field == null;
    }

    function isNullableNumber(field) {
      return field is number || field == null;
    }

    function hasValidCoords(coords) {
      return coords is map &&
        coords.keys().hasOnly(['latitude','longitude','accuracy']) &&
        coords.latitude is number &&
        coords.longitude is number &&
        isNullableNumber(coords.accuracy);
    }

    /* Para eventos: accuracy razonable (≤ 100 m) si viene presente */
    function hasValidEventCoords(coords) {
      return hasValidCoords(coords) &&
        ( !(coords.accuracy is number) || coords.accuracy <= 100 );
    }

    /* ─────────── mensajesContacto ─────────── */
    match /mensajesContacto/{docId} {
      allow write: if
          request.time < timestamp.date(2026, 1, 1) &&
          request.resource.data.keys().hasOnly(
            ['nombre','email','mensaje','timestamp']
          ) &&
          request.resource.data.nombre is string &&
          request.resource.data.email  is string &&
          request.resource.data.mensaje is string &&
          request.resource.data.nombre.size()  <= 80 &&
          request.resource.data.email.size()   <= 120 &&
          request.resource.data.mensaje.size() <= 2000;
      allow read: if false; // bandeja privada
    }

    /* ─────────── GlobalEvents ─────────── */
    match /GlobalEvents/{eventId} {
      allow read: if true;
      allow write, delete:
        if request.auth != null &&
           request.auth.token.email == "f13vasconez@gmail.com";
    }

    /* ─────────── Participantes (abierto de prueba) ─────────── */
    match /Participantes/{userId} {
      allow read:  if true;
      allow write: if true;
    }

    /* ─────────── Colecciones públicas de solo lectura ─────────── */
    match /Field/{doc}     { allow read: if true; }
    match /Category/{doc}  { allow read: if true; }
    match /News/{doc}      { allow read: if true; }
    match /videoData/{doc} { allow read: if true; }
    match /Academy/{doc}   { allow read: if true; }

    /* ─────────── Location buckets por usuario ───────────
       (perfil/balde por usuario autenticado; PII permitida limitada) */
    match /users/{userId}/locationBuckets/{bucketId} {
      function isOwner() { return isOwnerUidOrEmail(userId); }

      function isValidPlaceField(field) { return field is string || field == null; }

      allow read: if isOwner();
      allow write: if isOwner()
        && request.resource.data.keys().hasOnly([
          'bucketId',
          'latCenter',
          'lngCenter',
          'count',
          'updatedAt',
          'source',
          'lastResolvedNeighborhood',
          'lastResolvedCity',
          'lastResolvedRegion',
          'lastResolvedCountry',
          'lastResolvedIsoCountry',
          'lastResolvedFormatted'
        ])
        && request.resource.data.bucketId is string
        && request.resource.data.bucketId == bucketId
        && request.resource.data.latCenter is number
        && request.resource.data.lngCenter is number
        && request.resource.data.count is number
        && request.resource.data.updatedAt is timestamp
        && (!('source' in request.resource.data) || request.resource.data.source is string)
        && (!('lastResolvedNeighborhood' in request.resource.data) || isValidPlaceField(request.resource.data.lastResolvedNeighborhood))
        && (!('lastResolvedCity' in request.resource.data) || isValidPlaceField(request.resource.data.lastResolvedCity))
        && (!('lastResolvedRegion' in request.resource.data) || isValidPlaceField(request.resource.data.lastResolvedRegion))
        && (!('lastResolvedCountry' in request.resource.data) || isValidPlaceField(request.resource.data.lastResolvedCountry))
        && (!('lastResolvedIsoCountry' in request.resource.data) || isValidPlaceField(request.resource.data.lastResolvedIsoCountry))
        && (!('lastResolvedFormatted' in request.resource.data) || isValidPlaceField(request.resource.data.lastResolvedFormatted));
    }

    /* ─────────── Location buckets global (por usuario) ───────────
       (whitelist estricta; requiere request.auth y propiedad) */
    match /locationBuckets/{docId} {
      function isOwnerField(userId) { return isOwnerUidOrEmail(userId); }

      allow read: if isOwnerField(resource.data.userId);
      allow write: if request.resource != null && isOwnerField(request.resource.data.userId)
        && request.resource.data.keys().hasOnly([
          'userId',
          'userEmail',
          'consentGiven',
          'coords',
          'cityId',
          'bucketId',
          'createdAt'
        ])
        && request.resource.data.userId is string
        && request.resource.data.bucketId is string
        && request.resource.data.consentGiven is bool
        && isNullableString(request.resource.data.userEmail)
        && isNullableString(request.resource.data.cityId)
        && hasValidCoords(request.resource.data.coords)
        && request.resource.data.createdAt is timestamp;
    }

    /* ─────────── locationEvents (eventos anonimizados para analítica) ───────────
       Destinado a guardar eventos enriquecidos SIN PII (usa userAnonId). */
    match /locationEvents/{docId} {
      function hasValidEnrichedEvent(data) {
        return
          // Whitelist de campos permitidos
          data.keys().hasOnly([
            'bucketId',
            'cityId',
            'userAnonId',
            'consentGiven',
            'coords',
            'geohash',
            'date',
            'hour',
            'weekday',
            'locationMethod',
            'permissionStatus',
            'eventType',
            'appVersion',
            'platform',
            'provinceId',
            'cantonId',
            'parishId',
            'neighborhoodSlug',
            'timestamp'
          ])
          // Tipos y validaciones mínimas
          && (data.bucketId is string)
          && (isNullableString(data.cityId))
          && (data.userAnonId is string && data.userAnonId.size() >= 32) // hash hex
          && (data.consentGiven == true)
          && (hasValidEventCoords(data.coords))
          && (data.geohash is string && data.geohash.size() >= 5 && data.geohash.size() <= 12)
          && (data.date is string)      // 'YYYY-MM-DD' (no validamos regex en reglas)
          && (data.hour is number && data.hour >= 0 && data.hour <= 23)
          && (data.weekday is number && data.weekday >= 0 && data.weekday <= 6)
          && (data.locationMethod is string)
          && (data.permissionStatus is string)
          && (data.eventType is string)
          && (data.appVersion is string)
          && (data.platform is string)
          && (isNullableString(data.provinceId))
          && (isNullableString(data.cantonId))
          && (isNullableString(data.parishId))
          && (isNullableString(data.neighborhoodSlug))
          // timestamp: aceptamos number (ms epoch) o timestamp Firestore
          && ((data.timestamp is number) || (data.timestamp is timestamp));
      }

      // Escritura: requiere usuario autenticado (no PII en el doc)
      allow write: if request.auth != null && hasValidEnrichedEvent(request.resource.data);

      // Lectura: por defecto cerrado (ajusta a tu necesidad: true, auth-only, etc.)
      allow read: if false;
    }

    /* ─────────── cellsDaily (agregados por celda/día) ───────────
       Escribe solo backend/admin; el cliente puede leer si lo necesitas. */
    match /cellsDaily/{docId} {
      // Lectura pública opcional para mapas; cámbialo a `if request.auth != null` si prefieres.
      allow read: if true;

      // NO permitir escritura desde cliente
      allow write: if false;
    }
  }
}
