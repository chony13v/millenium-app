rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ─────────────────────── Helpers ─────────────────────── */
    function isOwnerUidOrEmail(userId) {
      return request.auth != null &&
        (
          request.auth.uid == userId ||
          (request.auth.token.email != null && request.auth.token.email == userId)
        );
    }

    function isNullableString(field) {
      return field is string || field == null;
    }

    function hasValidCoords(coords) {
      return coords is map &&
        coords.keys().hasOnly(['latitude','longitude']) &&
        coords.latitude is number &&
        coords.longitude is number;
    }

    /* ─────────── mensajesContacto ─────────── */
    match /mensajesContacto/{docId} {
      allow write: if
          request.time < timestamp.date(2026, 1, 1) &&
          request.resource.data.keys().hasOnly(
            ['nombre','email','mensaje','timestamp']
          ) &&
          request.resource.data.nombre is string &&
          request.resource.data.email  is string &&
          request.resource.data.mensaje is string &&
          request.resource.data.nombre.size()  <= 80 &&
          request.resource.data.email.size()   <= 120 &&
          request.resource.data.mensaje.size() <= 2000;
      allow read: if false; // bandeja privada
    }

    /* ─────────── GlobalEvents ─────────── */
    match /GlobalEvents/{eventId} {
      allow read: if true;
      allow write, delete:
        if request.auth != null &&
           request.auth.token.email == "f13vasconez@gmail.com";
    }

    /* ─────────── Participantes (abierto de prueba) ─────────── */
    match /Participantes/{userId} {
      allow read:  if true;
      allow write: if true;
    }

    /* ─────────── Colecciones públicas de solo lectura ─────────── */
    match /Field/{doc}     { allow read: if true; }
    match /Category/{doc}  { allow read: if true; }
    match /News/{doc}      { allow read: if true; }
    match /videoData/{doc} { allow read: if true; }
    match /Academy/{doc}   { allow read: if true; }

    /* ─────────── Location buckets por usuario ───────────
       (perfil/balde por usuario autenticado; PII permitida limitada) */
    match /users/{userId}/locationBuckets/{bucketId} {
      function isOwner() { return isOwnerUidOrEmail(userId); }

      function isValidPlaceField(field) { return field is string || field == null; }

      allow read: if isOwner();
      allow write: if isOwner()
        && request.resource.data.keys().hasOnly([
          'bucketId',
          'userId',
          'userEmail',
          'cityId',
          'coords',
          'geohash',
          'platform',
          'appVersion',
          'createdAt'
        ])
        && request.resource.data.bucketId is string
        && request.resource.data.bucketId == bucketId
        && request.resource.data.userId is string
        && isNullableString(request.resource.data.userEmail)
        && isNullableString(request.resource.data.cityId)
        && hasValidCoords(request.resource.data.coords)
        && request.resource.data.geohash is string
        && request.resource.data.platform is string
        && request.resource.data.appVersion is string
        && request.resource.data.createdAt is timestamp;
    }

    /* ─────────── Location buckets global (por usuario) ───────────
       (whitelist estricta; requiere request.auth y propiedad) */
    match /locationBuckets/{docId} {
      function isOwnerField(userId) { return isOwnerUidOrEmail(userId); }

      allow read: if isOwnerField(resource.data.userId);
      allow write: if request.resource != null && isOwnerField(request.resource.data.userId)
        && request.resource.data.keys().hasOnly([
          'userId',
          'userEmail',
          'coords',
          'cityId',
          'bucketId',
          'geohash',
          'platform',
          'appVersion',
          'createdAt'
        ])
        && request.resource.data.userId is string
        && request.resource.data.bucketId is string
        && isNullableString(request.resource.data.userEmail)
        && isNullableString(request.resource.data.cityId)
        && hasValidCoords(request.resource.data.coords)
        && request.resource.data.geohash is string
        && request.resource.data.platform is string
        && request.resource.data.appVersion is string
        && request.resource.data.createdAt is timestamp;
    }

    /* ─────────── locationEvents (eventos de ubicación simplificados) ───────────
       Destinado a guardar los datos mínimos necesarios para analítica. */
    match /locationEvents/{docId} {
      function hasValidEnrichedEvent(data) {
        return
          // Whitelist de campos permitidos
          data.keys().hasOnly([
            'userId',
            'userEmail',
            'cityId',
            'bucketId',
            'coords',
            'geohash',
            'platform',
            'appVersion',
            'createdAt'
          ])
          // Tipos y validaciones mínimas
          && (data.userId is string)
          && (data.bucketId is string)
          && (isNullableString(data.userEmail))
          && (isNullableString(data.cityId))
          && (hasValidCoords(data.coords))
          && (data.geohash is string && data.geohash.size() >= 5 && data.geohash.size() <= 12)
          && (data.platform is string)
          && (data.appVersion is string)
          && (data.createdAt is timestamp);
      }

      // Escritura: requiere usuario autenticado (no PII en el doc)
      allow write: if request.auth != null && hasValidEnrichedEvent(request.resource.data);

      // Lectura: por defecto cerrado (ajusta a tu necesidad: true, auth-only, etc.)
      allow read: if false;
    }

    /* ─────────── cellsDaily (agregados por celda/día) ───────────
       Escribe solo backend/admin; el cliente puede leer si lo necesitas. */
    match /cellsDaily/{docId} {
      // Lectura pública opcional para mapas; cámbialo a `if request.auth != null` si prefieres.
      allow read: if true;

      // NO permitir escritura desde cliente
      allow write: if false;
    }
  }
}