rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isOwnerUidOrEmail(userId) {
      return request.auth != null &&
        (
          request.auth.uid == userId ||
          (request.auth.token.email != null && request.auth.token.email == userId) ||
          (request.auth.token.sub != null && request.auth.token.sub == userId) ||
          (request.auth.token.user_id != null && request.auth.token.user_id == userId)
        );
    }

    function isNullableString(field) {
      return field is string || field == null;
    }

    function hasValidCoords(coords) {
      return coords is map &&
        coords.keys().hasOnly(['latitude','longitude']) &&
        coords.latitude is number &&
        coords.longitude is number;
    }

    function isAdmin() {
      return request.auth != null &&
        request.auth.token.email == "f13vasconez@gmail.com"; // ajusta si necesitas otro admin
    }

    function isNullableTimestamp(field) {
      return field is timestamp || field == null;
    }

    // ── mensajesContacto ──
    match /mensajesContacto/{docId} {
      allow write: if
        request.resource.data.keys().hasOnly(['nombre','email','mensaje','timestamp']) &&
        request.resource.data.nombre is string &&
        request.resource.data.email  is string &&
        request.resource.data.mensaje is string &&
        request.resource.data.nombre.size()  <= 80 &&
        request.resource.data.email.size()   <= 120 &&
        request.resource.data.mensaje.size() <= 2000;
      allow read: if false;
    }

    /* ── GlobalEvents ── */
    match /GlobalEvents/{eventId} {
      allow read: if true;
      allow write, delete: if isAdmin();
    }

    /* ── Participantes ── */
    match /Participantes/{userId} {
      // Solo el dueño o el admin pueden leer/escribir
      allow read, write: if isOwnerUidOrEmail(userId) || isAdmin();
    }

    /* ── Colecciones públicas de solo lectura ── */
    match /Field/{doc}     { allow read: if true; }
    match /Category/{doc}  { allow read: if true; }
    match /News/{doc}      { allow read: if true; }
    match /videoData/{doc} { allow read: if true; }
    match /Academy/{doc}   { allow read: if true; }
    match /rewards/{rewardId} {
      allow read: if true;
      allow write, delete: if isAdmin();
    }

    /* ── Encuestas dinámicas ── */
    match /surveys/{surveyId} {
      allow read: if true;
      allow write: if isAdmin()
        && request.resource.data.keys().hasOnly([
          'title','question','options','cityId','isActive','createdAt','updatedAt'
        ])
        && request.resource.data.title is string
        && request.resource.data.question is string
        && request.resource.data.options is list
        && request.resource.data.options.size() > 0
        && request.resource.data.options[0] is string
        && request.resource.data.cityId is string
        && request.resource.data.isActive is bool
        && request.resource.data.createdAt is timestamp
        && request.resource.data.updatedAt is timestamp;
    }

    /* ── Config encuesta activa (opcional) ── */
    match /config/activeSurvey {
      allow read: if true;
      allow write: if isAdmin()
        && request.resource.data.keys().hasOnly(['surveyId','updatedAt'])
        && request.resource.data.surveyId is string
        && request.resource.data.updatedAt is timestamp;
    }

    /* ── Respuestas de encuestas ── */
    match /surveyResponses/{responseId} {
      allow read: if request.auth != null && isOwnerUidOrEmail(resource.data.userId);
      allow create: if request.auth != null
        && request.resource.data.keys().hasOnly(['surveyId','answer','userId','cityId','createdAt','coords'])
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.surveyId is string
        && request.resource.data.answer is string
        && isNullableString(request.resource.data.cityId)
        && request.resource.data.createdAt is timestamp
        && (
          !request.resource.data.keys().hasAny(['coords'])
          || request.resource.data.coords == null
          || hasValidCoords(request.resource.data.coords)
        );
      allow update, delete: if false;
    }

    /* ── Reportes ciudadanos ── */
    match /cityReports/{reportId} {
      allow read: if request.auth != null && isOwnerUidOrEmail(resource.data.userId);
      allow create: if request.auth != null
        && request.resource.data.keys().hasOnly([
          'problemType','description','locationText','coords',
          'photoUrl','userId','cityId','status','createdAt'
        ])
        && request.resource.data.userId is string
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.problemType is string
        && request.resource.data.description is string
        && request.resource.data.locationText is string
        && (
          !request.resource.data.keys().hasAny(['coords']) ||
          request.resource.data.coords == null ||
          hasValidCoords(request.resource.data.coords)
        )
        && isNullableString(request.resource.data.photoUrl)
        && isNullableString(request.resource.data.cityId)
        && request.resource.data.status == "pendiente"
        && request.resource.data.createdAt is timestamp;
      allow update, delete: if false;
    }

    /* ── Eventos semanales ── */
    match /weeklyEvents/{eventId} {
      allow read: if true;
      allow write, delete: if isAdmin()
        && request.resource.data.keys().hasOnly([
          'title','description','cityId','isActive','weekRange','createdAt','updatedAt'
        ])
        && request.resource.data.title is string
        && request.resource.data.description is string
        && (isNullableString(request.resource.data.cityId))
        && request.resource.data.isActive is bool
        && (isNullableString(request.resource.data.weekRange))
        && (isNullableTimestamp(request.resource.data.createdAt))
        && (isNullableTimestamp(request.resource.data.updatedAt));
    }

    /* ── Asistencias a eventos semanales ── (más permisivo + UPDATE seguro) */
    match /weeklyEventAttendance/{attendanceId} {
      // Solo el dueño puede leer su registro de asistencia
      allow read: if request.auth != null
        && isOwnerUidOrEmail(resource.data.userId);

      // Crear registro de asistencia (cliente)
      allow create: if request.auth != null
        && isOwnerUidOrEmail(request.resource.data.userId)
        && request.resource.data.eventId is string
        // cityId opcional
        && (
          !request.resource.data.keys().hasAny(['cityId']) ||
          isNullableString(request.resource.data.cityId)
        )
        // attendedAt opcional (timestamp o null)
        && (
          !request.resource.data.keys().hasAny(['attendedAt']) ||
          request.resource.data.attendedAt is timestamp ||
          request.resource.data.attendedAt == null
        )
        // createdAt opcional (timestamp o null)
        && (
          !request.resource.data.keys().hasAny(['createdAt']) ||
          request.resource.data.createdAt is timestamp ||
          request.resource.data.createdAt == null
        )
        // coords opcional, pero si viene debe ser válido
        && (
          !request.resource.data.keys().hasAny(['coords']) ||
          request.resource.data.coords == null ||
          hasValidCoords(request.resource.data.coords)
        )
        // photoUrl opcional
        && (
          !request.resource.data.keys().hasAny(['photoUrl']) ||
          isNullableString(request.resource.data.photoUrl)
        );

      // UPDATE: solo el dueño; no se permite cambiar userId ni eventId;
      // campos opcionales validados; permite transforms (updatedAt = REQUEST_TIME)
      allow update: if request.auth != null
        && isOwnerUidOrEmail(resource.data.userId)
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.eventId == resource.data.eventId
        // coords opcional y válida
        && (
          !request.resource.data.keys().hasAny(['coords']) ||
          request.resource.data.coords == null ||
          hasValidCoords(request.resource.data.coords)
        )
        // photoUrl opcional
        && (
          !request.resource.data.keys().hasAny(['photoUrl']) ||
          isNullableString(request.resource.data.photoUrl)
        )
        // cityId opcional
        && (
          !request.resource.data.keys().hasAny(['cityId']) ||
          isNullableString(request.resource.data.cityId)
        );

      // Borrado desde cliente no permitido
      allow delete: if false;
    }

    /* ── Location buckets por usuario ── */
    match /users/{userId}/locationBuckets/{bucketId} {
      function isOwner() { return isOwnerUidOrEmail(userId); }
      allow read: if isOwner();
      allow write: if isOwner()
        && request.resource.data.keys().hasOnly([
          'bucketId','userId','userEmail','cityId','coords',
          'geohash','platform','appVersion','createdAt'
        ])
        && request.resource.data.bucketId is string
        && request.resource.data.bucketId == bucketId
        && request.resource.data.userId is string
        && isNullableString(request.resource.data.userEmail)
        && isNullableString(request.resource.data.cityId)
        && hasValidCoords(request.resource.data.coords)
        && request.resource.data.geohash is string
        && request.resource.data.platform is string
        && request.resource.data.appVersion is string
        && request.resource.data.createdAt is timestamp;
    }

    /* ── Reporte de eventos por usuario (bloqueo de reenvío, más permisivo) ── */
    match /users/{userId}/eventReports/{eventId} {
      // Solo lectura para el dueño
      allow read: if isOwnerUidOrEmail(userId);

      // Crear reporte de evento (campos extra permitidos)
      allow create: if request.auth != null
        && isOwnerUidOrEmail(userId)
        && request.resource.data.userId == userId
        && request.resource.data.eventId is string
        && (
          !request.resource.data.keys().hasAny(['createdAt']) ||
          request.resource.data.createdAt is timestamp
        );

      // Nada de updates/deletes desde cliente
      allow update, delete: if false;
    }

    /* ── Location buckets global ── */
    match /locationBuckets/{docId} {
      function isOwnerField(userId) { return isOwnerUidOrEmail(userId); }
      allow read: if isOwnerField(resource.data.userId);
      allow write: if request.resource != null && isOwnerField(request.resource.data.userId)
        && request.resource.data.keys().hasOnly([
          'userId','userEmail','coords','cityId','bucketId',
          'geohash','platform','appVersion','createdAt'
        ])
        && request.resource.data.userId is string
        && request.resource.data.bucketId is string
        && isNullableString(request.resource.data.userEmail)
        && isNullableString(request.resource.data.cityId)
        && hasValidCoords(request.resource.data.coords)
        && request.resource.data.geohash is string
        && request.resource.data.platform is string
        && request.resource.data.appVersion is string
        && request.resource.data.createdAt is timestamp;
    }

    /* ── locationEvents ── */
    match /locationEvents/{docId} {
      function hasValidEnrichedEvent(data) {
        return data.keys().hasOnly([
            'userId','userEmail','cityId','bucketId','coords',
            'geohash','platform','appVersion','createdAt'
          ])
          && (data.userId is string)
          && (data.bucketId is string)
          && (isNullableString(data.userEmail))
          && (isNullableString(data.cityId))
          && (hasValidCoords(data.coords))
          && (data.geohash is string && data.geohash.size() >= 5 && data.geohash.size() <= 12)
          && (data.platform is string)
          && (data.appVersion is string)
          && (data.createdAt is timestamp);
      }

      // Solo puede escribir eventos de localización para sí mismo
      allow write: if request.auth != null
        && hasValidEnrichedEvent(request.resource.data)
        && request.resource.data.userId == request.auth.uid;

      allow read: if false;
    }

    /* ── cellsDaily ── */
    match /cellsDaily/{docId} {
      allow read: if true;
      allow write: if false;
    }

    /* ── Perfil público (solo lectura) ── */
    match /users/{userId}/public_profile/{docId} {
      allow read: if true;
      allow write: if false;
    }

    /* ── Metadatos de referidos por usuario ── */
    match /users/{userId}/referral_meta/{docId} {
      allow read: if isOwnerUidOrEmail(userId);
      allow write: if false;
    }

    /* ── Códigos de referidos ── */
    match /referralCodes/{code} {
      // No se permite lectura ni escritura desde el cliente
      allow read: if false;
      allow write: if false;
    }

    /* ── Canjes de recompensas ── */
    match /redemptions/{redemptionId} {
      // Lectura:
      // - get: pública para que /canje?id=... pueda consultar el cupón por ID
      // - list: bloqueada para evitar enumerar cupones
      allow get: if true;
      allow list: if request.auth != null && resource.data.userId == request.auth.uid;

      // Creación desde la app (mismas validaciones que tenías)
      allow create: if request.auth != null
        && request.resource.data.keys().hasOnly([
          'id','userId','rewardId','merchantId','status',
          'createdAt','expiresAt','qrUrl','cityId','appVersion'
        ])
        && request.resource.data.id == redemptionId
        && request.resource.data.userId is string
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.rewardId is string
        && request.resource.data.merchantId is string
        && request.resource.data.status == "pending"
        && request.resource.data.createdAt is timestamp
        && isNullableTimestamp(request.resource.data.expiresAt)
        && request.resource.data.qrUrl is string
        && isNullableString(request.resource.data.cityId)
        && (!request.resource.data.keys().hasAny(['appVersion']) || isNullableString(request.resource.data.appVersion));

      // Actualizaciones y borrados solo vía Admin SDK (Cloud Functions)
      allow update, delete: if false;
    }

    /* ── Canjes de referidos ── */
    match /referralRedemptions/{redemptionId} {
      allow read: if request.auth != null
        && (resource.data.referrerUid == request.auth.uid || resource.data.redeemerUid == request.auth.uid);
      allow write: if false;
    }

    /* ── Estadísticas de referidos ── */
    match /referral_stats/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false;
    }

    // ── Perfil de puntos ──
    match /users/{userId}/points_profile/{docId} {
      // Lectura abierta para evitar fallos de verificación si la sesión aún no se enlaza
      allow read: if true;

      // Escritura: solo el dueño (cliente o CF)
      allow write: if request.auth != null
        && isOwnerUidOrEmail(userId)
        && docId == "profile";
    }

    /* ── Historial (ledger) de puntos ── */
    match /users/{userId}/points_ledger/{entryId} {
      // Solo el dueño puede leer su historial
      allow read: if isOwnerUidOrEmail(userId);

      // El dueño puede crear o actualizar sus entradas (p.ej. para set() con merge)
      allow create, update: if request.auth != null
        && isOwnerUidOrEmail(userId);

      // No permitimos delete desde el cliente
      allow delete: if false;
    }

    /* ── Marcadores diarios de social engagement ── */
    match /users/{userId}/social_meta/{docId} {
      allow read: if isOwnerUidOrEmail(userId);
      allow write: if false;
    }

    /* ── (Opcional) Log de clics en redes oficiales ── */
    match /users/{userId}/social_clicks/{docId} {
      allow read: if isOwnerUidOrEmail(userId);
      allow create: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.keys().hasOnly(['linkId','platform','createdAt'])
        && request.resource.data.linkId is string
        && request.resource.data.platform in ['instagram','tiktok','youtube','facebook']
        && request.resource.data.createdAt is timestamp;
      allow update, delete: if false;
    }
  }
}
